var Chat={};Chat.startStream=function(){WebRTC.getMedia(),Chat.log(Lang.get("log_get_stream"))},Chat.stopStream=function(){Socket.sendMessage("stop"),WebRTC.close(),Socket.ws.close(),this.localStream.classList.add("camera-off"),this.startBtn.innerText=Lang.get("start"),this.started=!1,this.localVideo.pause(),this.localVideo.src="",WebRTC.localStream.stop()},Chat.nextStream=function(){Chat.log(Lang.get("log_search")),WebRTC.refresh(),Socket.sendMessage("next")},Chat.sendMessage=function(){Socket.sendMessage("message",Chat.textarea.value),Chat.textarea.value=""},Chat.clearHistory=function(){Chat.history.innerHTML=""},Chat.fullScreen=function(){var e,t=document.querySelector(".view");document.querySelector(".stream-bar").classList.remove("big"),document.fullscreenElement||document.msFullscreenElement||document.webkitCurrentFullScreenElement||document.mozFullScreenElemenz?(e=document,e.exitFullscreen?e.exitFullscreen():e.msExitFullscreen?e.msExitFullscreen():e.webkitCancelFullScreen?e.webkitCancelFullScreen():e.mozCancelFullScreen&&e.mozCancelFullScreen(),t.classList.remove("fullscreen")):(e=document.documentElement,e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.webkitRequestFullScreen?e.webkitRequestFullScreen():e.mozRequestFullScreen&&e.mozRequestFullScreen(),t.classList.add("fullscreen"))},Chat.log=function(e,t){t&&this.clearHistory(),this.pushMesage({text:e,author:"system"})},Chat.pushMesage=function(e){var t=document.createElement("div"),f=document.createElement("span");f.innerText=e.text,f.innerHTML=twemoji.parse(f.innerText.autoLink({callback:function(e){var t=/\.(gif|png|jpe?g)$/i.test(e)?'<img src="'+e+'">':e;return'<a target="_blank" class="image" href="'+e+'">'+t+"</a>"}}),function(e){return"https://twemoji.maxcdn.com/svg/"+e+".svg"}),t.classList.add("message"),t.classList.add(e.author),t.appendChild(f),Chat.history.appendChild(t),"partner"==e.author&&Chat.showNotification(e.text),Chat.history.scrollTop=Chat.history.scrollHeight},Chat.showNotification=function(e){if(window.navigator.vibrate&&window.navigator.vibrate(100),4==this.audio.readyState&&(this.audio.currentTime=0,this.audio.play()),Notification&&"undefined"!=document.hidden){if("granted"!=Notification.permission)Notification.requestPermission();else if("granted"==Notification.permission&&document.hidden){var t=new Notification("RuletkaJS",{body:e,icon:"/img/icon_192.png"});t.onclick=function(){window.focus()}}}else console.warn("Notification not supported")},Chat.getStreamSources=function(){window.MediaStreamTrack&&window.MediaStreamTrack.getSources(function(e){for(var t={audio:document.createElement("ul"),video:document.createElement("ul"),option:document.createElement("ul")},f=function(){WebRTC.constraints[this.dataset.kind]={optional:[{sourceId:this.dataset.id}]},console.log(this.value,WebRTC.constraints)},n=0;n<e.length;n++){var a=document.createElement("li");a.innerText=e[n].label||e[n].kind+" "+(t[e[n].kind].childElementCount+1),a.dataset.id=e[n].id,a.dataset.kind=e[n].kind,t[e[n].kind].appendChild(a),a.onclick=f}var o=document.createElement("li");o.innerText=Lang.get("flip_video"),o.onclick=function(){Chat.localVideo.classList.toggle("flip")},t.option.appendChild(o),Chat.sources.innerHTML="";for(var i in t){var c=document.createElement("div");c.className="title",c.innerText=Lang.get(i),Chat.sources.appendChild(c),Chat.sources.appendChild(t[i])}})},Chat.setSmiles=function(){console.time("smile");for(var e=document.createDocumentFragment(),t=0;t<EmojiGroup.length;t++){var f=document.createElement("div");f.className="title",f.innerText=Lang.get("smile_"+EmojiGroup[t].key),e.appendChild(f);for(var n=0;n<EmojiGroup[t].emoji.length;n++){var a=document.createElement("div");a.className="smile",a.innerHTML="&#x"+EmojiGroup[t].emoji[n].split("-").join(";&#x")+";",a.onclick=function(){Chat.textarea.focus();var e=Chat.textarea.selectionStart;Chat.textarea.value=Chat.textarea.value.substring(0,e)+this+Chat.textarea.value.substring(e,Chat.textarea.value.length)}.bind(a.innerHTML),e.appendChild(a)}}twemoji.parse(e,{callback:function(e){return"https://twemoji.maxcdn.com/svg/"+e+".svg"}}),Chat.smiles.appendChild(e),console.timeEnd("smile")},Chat.onLoad=function(){Lang.setLanguage(),this.started=!1,this.audio=new Audio("notification.mp3"),this.history=document.getElementById("history"),this.sources=document.getElementById("sources"),this.textarea=document.getElementById("textarea"),this.localVideo=document.getElementById("localVideo"),this.remoteVideo=document.getElementById("remoteVideo"),this.localStream=document.getElementById("localStream"),this.remoteStream=document.getElementById("remoteStream"),this.sendBtn=document.querySelector(".submit-btn"),this.startBtn=document.getElementById("start-btn"),this.stopBtn=document.getElementById("stop-btn"),this.reportBtn=document.getElementById("report-btn"),this.cameraInfo=document.getElementById("camera-info"),this.cameraInfo.innerText=Lang.get("camera-on"),this.smiles=document.querySelector(".smile-picker .scroll-content"),this.sendBtn.addEventListener("click",Chat.sendMessage),this.textarea.addEventListener("keydown",function(e){13!=e.keyCode||e.shiftKey||(e.preventDefault(),Chat.sendMessage())}),this.startBtn.addEventListener("click",function(){Chat.started?Chat.nextStream():Chat.startStream()}),this.stopBtn.addEventListener("click",function(){Chat.started&&Chat.stopStream()}),this.startBtn.innerText=Lang.get("start"),this.stopBtn.innerText=Lang.get("stop"),this.reportBtn.innerText=Lang.get("report"),this.getStreamSources(),document.querySelector(".switch").onclick=function(){var e=document.querySelector(".view");e.classList.toggle("streams"),e.classList.toggle("chat"),ScrollBar.set()},document.querySelector("video").ondblclick=function(){Chat.fullScreen()},document.querySelector(".option-btn").onclick=function(){document.querySelector(".option-menu").classList.toggle("visible")},document.querySelector(".smile-btn").onclick=function(){document.querySelector(".smile-picker").classList.toggle("visible")},document.querySelector(".smile-picker").addEventListener("click",function(){this.classList.add("visible")}),document.body.addEventListener("click",function(e){e.target!=document.querySelector(".option-btn")&&e.target!=document.querySelector(".smile-btn")&&(document.querySelector(".smile-picker").classList.remove("visible"),document.querySelector(".option-menu").classList.remove("visible"))},!0),Chat.setSmiles(),ScrollBar.init(),Resize.init(),Chat.log(Lang.get("log_start"))},window.addEventListener("load",Chat.onLoad.bind(Chat));var EmojiGroup=[{key:"people",emoji:["1f600","1f601","1f602","1f603","1f604","1f605","1f606","1f607","1f608","1f47f","1f609","1f60a","263a","1f60b","1f60c","1f60d","1f60e","1f60f","1f610","1f611","1f612","1f613","1f614","1f615","1f616","1f617","1f618","1f619","1f61a","1f61b","1f61c","1f61d","1f61e","1f61f","1f620","1f621","1f622","1f623","1f624","1f625","1f626","1f627","1f628","1f629","1f62a","1f62b","1f62c","1f62d","1f62e","1f62f","1f630","1f631","1f632","1f633","1f634","1f635","1f636","1f637","1f638","1f639","1f63a","1f63b","1f63c","1f63d","1f63e","1f63f","1f640","1f463","1f464","1f465","1f476","1f466","1f467","1f468","1f469","1f46a","1f468","1f469","1f467","1f468","1f469","1f467","1f466","1f468","1f469","1f466","1f466","1f468","1f469","1f467","1f467","1f469","1f469","1f466","1f469","1f469","1f467","1f469","1f469","1f467","1f466","1f469","1f469","1f466","1f466","1f469","1f469","1f467","1f467","1f468","1f468","1f466","1f468","1f468","1f467","1f468","1f468","1f467","1f466","1f468","1f468","1f466","1f466","1f468","1f468","1f467","1f467","1f46b","1f46c","1f46d","1f46f","1f470","1f471","1f472","1f473","1f474","1f475","1f46e","1f477","1f478","1f482","1f47c","1f385","1f47b","1f479","1f47a","1f4a9","1f480","1f47d","1f47e","1f647","1f481","1f645","1f646","1f64b","1f64e","1f64d","1f486","1f487","1f491","1f469","2764","1f469","1f468","2764","1f468","1f48f","1f469","2764","1f48b","1f469","1f468","2764","1f48b","1f468","1f64c","1f44f","1f442","1f440","1f443","1f444","1f48b","1f445","1f485","1f44b","1f44d","1f44e","261d","1f446","1f447","1f448","1f449","1f44c","270c","1f44a","270a","270b","1f4aa","1f450","1f64f"]},{key:"nature",emoji:["1f331","1f332","1f333","1f334","1f335","1f337","1f338","1f339","1f33a","1f33b","1f33c","1f490","1f33e","1f33f","1f340","1f341","1f342","1f343","1f344","1f330","1f400","1f401","1f42d","1f439","1f402","1f403","1f404","1f42e","1f405","1f406","1f42f","1f407","1f430","1f408","1f431","1f40e","1f434","1f40f","1f411","1f410","1f413","1f414","1f424","1f423","1f425","1f426","1f427","1f418","1f42a","1f42b","1f417","1f416","1f437","1f43d","1f415","1f429","1f436","1f43a","1f43b","1f428","1f43c","1f435","1f648","1f649","1f64a","1f412","1f409","1f432","1f40a","1f40d","1f422","1f438","1f40b","1f433","1f42c","1f419","1f41f","1f420","1f421","1f41a","1f40c","1f41b","1f41c","1f41d","1f41e","1f43e","26a1","1f525","1f319","2600","26c5","2601","1f4a7","1f4a6","2614","1f4a8","2744","1f31f","2b50","1f320","1f304","1f305","1f308","1f30a","1f30b","1f30c","1f5fb","1f5fe","1f310","1f30d","1f30e","1f30f","1f311","1f312","1f313","1f314","1f315","1f316","1f317","1f318","1f31a","1f31d","1f31b","1f31c","1f31e"]},{key:"food",emoji:["1f345","1f346","1f33d","1f360","1f347","1f348","1f349","1f34a","1f34b","1f34c","1f34d","1f34e","1f34f","1f350","1f351","1f352","1f353","1f354","1f355","1f356","1f357","1f358","1f359","1f35a","1f35b","1f35c","1f35d","1f35e","1f35f","1f361","1f362","1f363","1f364","1f365","1f366","1f367","1f368","1f369","1f36a","1f36b","1f36c","1f36d","1f36e","1f36f","1f370","1f371","1f372","1f373","1f374","1f375","2615","1f376","1f377","1f378","1f379","1f37a","1f37b","1f37c"]},{key:"celebration",emoji:["1f380","1f381","1f382","1f383","1f384","1f38b","1f38d","1f391","1f386","1f387","1f389","1f38a","1f388","1f4ab","2728","1f4a5","1f393","1f451","1f38e","1f38f","1f390","1f38c","1f38c","1f3ee","1f48d","2764","1f494","1f48c","1f495","1f49e","1f493","1f497","1f496","1f498","1f49d","1f49f","1f49c","1f49b","1f49a","1f499"]},{key:"activity",emoji:["1f380","1f381","1f382","1f383","1f384","1f38b","1f38d","1f391","1f386","1f387","1f389","1f38a","1f388","1f4ab","2728","1f4a5","1f393","1f451","1f38e","1f38f","1f390","1f38c","1f38c","1f3ee","1f48d","2764","1f494","1f48c","1f495","1f49e","1f493","1f497","1f496","1f498","1f49d","1f49f","1f49c","1f49b","1f49a","1f499"]},{key:"travel",emoji:["1f683","1f69e","1f682","1f68b","1f69d","1f684","1f685","1f686","1f687","1f688","1f689","1f68a","1f68c","1f68d","1f68e","1f690","1f691","1f692","1f693","1f694","1f6a8","1f695","1f696","1f697","1f698","1f699","1f69a","1f69b","1f69c","1f6b2","1f68f","26fd","1f6a7","1f6a6","1f6a5","1f680","1f681","2708","1f4ba","2693","1f6a2","1f6a4","26f5","1f6a1","1f6a0","1f69f","1f6c2","1f6c3","1f6c4","1f6c5","1f4b4","1f4b6","1f4b7","1f4b5","1f5fd","1f5ff","1f301","1f5fc","26f2","1f3f0","1f3ef","1f307","1f306","1f303","1f309","1f3e0","1f3e1","1f3e2","1f3ec","1f3ed","1f3e3","1f3e4","1f3e5","1f3e6","1f3e8","1f3e9","1f492","26ea","1f3ea","1f3eb","1f1e6","1f1fa","1f1e6","1f1f9","1f1e7","1f1ea","1f1e7","1f1f7","1f1e8","1f1e6","1f1e8","1f1f1","1f1e8-1f1f3","1f1e8","1f1f4","1f1e9","1f1f0","1f1eb","1f1ee","1f1eb-1f1f7","1f1e9-1f1ea","1f1ed","1f1f0","1f1ee","1f1f3","1f1ee","1f1e9","1f1ee","1f1ea","1f1ee","1f1f1","1f1ee-1f1f9","1f1ef-1f1f5","1f1f0-1f1f7","1f1f2","1f1f4","1f1f2","1f1fe","1f1f2","1f1fd","1f1f3","1f1f1","1f1f3","1f1ff","1f1f3","1f1f4","1f1f5","1f1ed","1f1f5","1f1f1","1f1f5","1f1f9","1f1f5","1f1f7","1f1f7-1f1fa","1f1f8","1f1e6","1f1f8","1f1ec","1f1ff","1f1e6","1f1ea-1f1f8","1f1f8","1f1ea","1f1e8","1f1ed","1f1f9","1f1f7","1f1ec-1f1e7","1f1fa-1f1f8","1f1e6","1f1ea","1f1fb","1f1f3"]},{key:"objects",emoji:["231a","1f4f1","1f4f2","1f4bb","23f0","23f3","231b","1f4f7","1f4f9","1f3a5","1f4fa","1f4fb","1f4df","1f4de","260e","1f4e0","1f4bd","1f4be","1f4bf","1f4c0","1f4fc","1f50b","1f50c","1f4a1","1f526","1f4e1","1f4b3","1f4b8","1f4b0","1f48e","1f302","1f45d","1f45b","1f45c","1f4bc","1f392","1f484","1f453","1f452","1f461","1f460","1f462","1f45e","1f45f","1f459","1f457","1f458","1f45a","1f455","1f454","1f456","1f6aa","1f6bf","1f6c1","1f6bd","1f488","1f489","1f48a","1f52c","1f52d","1f52e","1f527","1f52a","1f529","1f528","1f4a3","1f6ac","1f52b","1f516","1f4f0","1f529","1f528","1f4a3","1f6ac","1f52b","1f516","1f4f0","1f511","2709","1f4e9","1f4e8","1f4e7","1f4e5","1f4e4","1f4e6","1f4ef","1f4ee","1f4ea","1f4eb","1f4ec","1f4ed","1f4c4","1f4c3","1f4d1","1f4c8","1f4c9","1f4ca","1f4c5","1f4c6","1f505","1f506","1f4dc","1f4cb","1f4d6","1f4d3","1f4d4","1f4d2","1f4d5","1f4d7","1f4d8","1f4d9","1f4da","1f4c7","1f517","1f4ce","1f4cc","2702","1f4d0","1f4cd","1f4cf","1f6a9","1f4c1","1f4c2","2712","270f","1f4dd","1f50f","1f510","1f512","1f513","1f4e3","1f4e2","1f508","1f509","1f50a","1f507","1f4a4","1f514","1f515","1f4ad","1f4ac","1f6b8","1f50d","1f50e","1f6ab","26d4","1f4db","1f6b7","1f6af","1f6b3","1f6b1","1f4f5","1f51e","1f251","1f250","1f4ae","3299","3297","1f234","1f235","1f232","1f236","1f21a","1f238","1f23a","1f237","1f239","1f233","1f202","1f201","1f22f","1f4b9","2747","2733","274e","2705","2734","1f4f3","1f4f4","1f19a","1f170","1f171","1f18e","1f191","1f17e","1f198","1f194","1f17f","1f6be","1f192","1f193","1f195","1f196","1f197","1f199","1f3e7","2648","2649","264a","264b","264c","264d","264e","264f","2650","2651","2652","2653","1f6bb","1f6b9","1f6ba","1f6bc","267f","1f6b0","1f6ad","1f6ae","25b6","25c0","1f53c","1f53d","23e9","23ea","23eb","23ec","27a1","2b05","2b06","2b07","2197","2198","2199","2196","2195","2194","1f504","21aa","21a9","2934","2935","1f500","1f501","1f502","23-20e3","30-20e3","31-20e3","32-20e3","33-20e3","34-20e3","35-20e3","36-20e3","37-20e3","38-20e3","39-20e3","1f51f","1f522","1f524","1f521","1f520","2139","1f4f6","1f3a6","1f523","2795","2796","3030","2797","2716","2714","1f503","2122","a9","ae","1f4b1","1f4b2","27b0","27bf","303d","2757","2753","2755","2754","203c","2049","274c","2b55","1f4af","1f51a","1f519","1f51b","1f51d","1f51c","1f300","24c2","26ce","1f52f","1f530","1f531","26a0","2668","267b","1f4a2","1f4a0","2660","2663","2665","2666","2611","26aa","26ab","1f518","1f534","1f535","1f53a","1f53b","1f538","1f539","1f536","1f537","25aa","25ab","2b1b","2b1c","25fc","25fb","25fe","25fd","1f532","1f533","1f550","1f551","1f552","1f553","1f554","1f555","1f556","1f557","1f558","1f559","1f55a","1f55b","1f55c","1f55d","1f55e","1f55f","1f560","1f561","1f562","1f563","1f564","1f565"]}],Lang={};Lang["default"]="en",Lang.dictionary={next:{en:"Next",ru:"Далее"},stop:{en:"Stop",ru:"Стоп"},start:{en:"Start",ru:"Старт"},audio:{en:"Audio",ru:"Аудио"},video:{en:"Video",ru:"Видео"},option:{en:"Option",ru:"Опции"},report:{en:"Report abuse",ru:"Сообщить о нарушении"},log_start:{en:'Click "Start" to start a video chat with a random person.',ru:"Нажмите кнопку «Старт», чтобы начать видеочат с случайным человеком."},log_get_stream:{en:"Allow this site to use your camera.",ru:"Разрешите этому сайту использовать вашу камеру."},log_search:{en:"Search companion...",ru:"Идет поиск собеседника..."},log_leave:{en:"The caller left a chat.",ru:"Ваш собеседник покинул видеочат."},log_next:{en:'The caller clicked "Next"',ru:"Ваш собеседник нажал «Далее»"},log_clouse_conecting:{en:"Clouse conecting.",ru:"Вы отключились от сервера."},log_clouse_disconected:{en:"Server disconected.",ru:"Соединение с сервером разорвано."},log_socket_error:{en:"Socket Error.",ru:"Ошибка Socket соединения"},log_no_conection:{en:"Server not connected",ru:"Соединение с сервером не установлено"},log_stream_error:{en:"Stream error, you need access to the camera",ru:"Ошибка получения потока, необходим доступ к камере"},log_partner_conected:{en:"The connection is established with the interlocutor.",ru:"Соединение с собеседником установлено."},log_webrtc_error:{en:"WebRTC Error",ru:"Ошибка WebRTC"},"camera-on":{en:"Turn on the camera",ru:"Включите камеру"},flip_video:{en:"Flip video",ru:"Отразить видео"},smile_people:{en:"People",ru:"Люди"},smile_nature:{en:"Nature",ru:"Природа"},smile_food:{en:"Food & Drink",ru:"Еда и Напитки"},smile_celebration:{en:"Celebration",ru:"Праздник"},smile_activity:{en:"Activity",ru:"Мероприятия"},smile_travel:{en:"Travel & Places",ru:"Путешествия и Места"},smile_objects:{en:"Objects & Symbols",ru:"Объекты и Символы"}},Lang.setLanguage=function(e){return this.language=(e||document.documentElement.lang||navigator.language||navigator.userLanguage||this["default"]).split("-")[0],this.language},Lang.translate=function(e){return"object"==typeof e?e[this.language]||e[this["default"]]:e},Lang.get=function(e){return Lang.dictionary[e]?this.translate(this.dictionary[e]):"["+e+"]"};var Resize={};Resize.init=function(){this.elements=document.querySelectorAll(".resize-line");for(var e=0;e<this.elements.length;e++)this.elements[e].addEventListener("dragstart",function(){return!1}),this.elements[e].addEventListener("mousedown",function(e){Resize.target=this,this.classList.contains("vertical")?(document.body.style.cursor="col-resize",Resize.start=this.parentElement.clientWidth):(document.body.style.cursor="row-resize",Resize.start=this.parentElement.clientHeight),Resize.xMouse=e.clientX,Resize.yMouse=e.clientY,document.ondragstart=function(){return!1},document.body.onselectstart=function(){return!1},document.body.style.webkitUserSelect=document.body.style.userSelect="none"}),window.addEventListener("mousemove",function(e){Resize.target&&(Resize.video(),Resize.target.classList.contains("vertical")?Resize.target.parentElement.style.width=Resize.start+(e.clientX-Resize.xMouse)+"px":Resize.target.parentElement.style.height=Resize.start+(Resize.yMouse-e.clientY)+"px")}),window.addEventListener("mouseup",function(){Resize.target=!1,document.body.style.cursor="default",document.ondragstart=null,document.body.onselectstart=null,document.body.style.webkitUserSelect=document.body.style.userSelect=""})},Resize.video=function(){var e=Chat.remoteVideo.clientHeight;e+=Chat.localVideo.videoHeight?Chat.remoteVideo.clientWidth*(Chat.localVideo.videoHeight/Chat.localVideo.videoWidth):Chat.localVideo.clientHeight,e+=document.querySelector(".control-panel").clientHeight,e+40>window.innerHeight-document.querySelector(".header").clientHeight&&!document.querySelector(".view").classList.contains("fullscreen")&&void 0==window.orientation?document.querySelector(".stream-bar").classList.add("big"):document.querySelector(".stream-bar").classList.remove("big"),ScrollBar.set()};var ScrollBar={};ScrollBar.init=function(){this.boxs=document.querySelectorAll(".scroll-box"),this.ctns=document.querySelectorAll(".scroll-box .scroll-content"),this.bars=document.querySelectorAll(".scroll-box .scroll-bar"),this.btns=document.querySelectorAll(".scroll-box .scroll-btn");for(var e=0;e<this.ctns.length;e++)this.ctns[e].onscroll=function(){ScrollBar.scroll(this)}.bind(e);window.addEventListener("resize",function(){ScrollBar.set(),Resize.video()}),this.set()},ScrollBar.set=function(){for(var e=0;e<ScrollBar.boxs.length;e++){ScrollBar.bars[e].classList.remove("visible"),ScrollBar.ctns[e].style.width="100%",ScrollBar.ctns[e].style.overflowY="hidden";var t=ScrollBar.ctns[e].clientWidth;ScrollBar.ctns[e].style.overflowY="scroll";var f=t-ScrollBar.ctns[e].clientWidth;ScrollBar.ctns[e].style.width=t+f+"px",ScrollBar.bars[e].classList.add("visible"),ScrollBar.scroll(e)}},ScrollBar.scroll=function(e){var t=this.ctns[e].clientHeight/this.ctns[e].scrollHeight;this.btns[e].style.height=100*t+"%",this.btns[e].style.top=this.ctns[e].scrollTop*t+"px"};var Socket={};Socket.create=function(){this.ws&&1==this.ws.readyState||(this.ws=new WebSocket(location.origin.replace(/^http/,"ws")),this.ws.addEventListener("open",this.onOpen),this.ws.addEventListener("message",this.onMessage),this.ws.addEventListener("close",this.onClose),this.ws.addEventListener("error",this.onError))},Socket.onOpen=function(){console.info("WS connected."),Chat.startBtn.innerText=Lang.get("next"),Chat.started=!0,Chat.interval=setInterval(function(){Socket.sendMessage("ping",{},!0)},5e3),Chat.nextStream()},Socket.onMessage=function(e){var t=JSON.parse(e.data),f=t.type,n=t.content;"conect"==f?(console.info(f),WebRTC.createOffer()):"join"==f?console.info(f):"webrtc"==f?(console.info(f),WebRTC.onMessage(n)):"leave"==f?(console.info(f),WebRTC.refresh(),Chat.log(Lang.get("log_leave"),!0)):"next"==f?(console.info(f),Chat.log(Lang.get("log_next"),!0),Chat.log(Lang.get("log_search")),WebRTC.refresh()):"message"==f?Chat.pushMesage(n):console.warn("unknown message",f,n)},Socket.onClose=function(e){clearInterval(Chat.interval),e.wasClean?Chat.log(Lang.get("log_clouse_conecting"),!0):Chat.log(Lang.get("log_clouse_disconected"),!0),Chat.stopStream()},Socket.onError=function(e){clearInterval(Chat.interval),Chat.log(Lang.get("log_socket_error"),!0),console.warn("Socket ERROR:",e.data)},Socket.sendMessage=function(e,t,f){this.ws&&1==this.ws.readyState?this.ws.send(JSON.stringify({type:e,content:t||!1})):f||Chat.log(Lang.get("log_no_conection"))};var WebRTC={};WebRTC.constraints={audio:!0,video:!0},WebRTC.create=function(){window.PeerConnection=window.PeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,window.IceCandidate=window.IceCandidate||window.mozRTCIceCandidate||window.RTCIceCandidate,window.SessionDescription=window.SessionDescription||window.mozRTCSessionDescription||window.RTCSessionDescription;var e=null;this.pc=new window.PeerConnection(e),this.pc.addStream(this.localStream),this.pc.onicecandidate=this.getIceCandidate.bind(this),this.pc.onaddstream=this.getRemoteStream.bind(this),Chat.remoteStream.classList.add("loading")},WebRTC.getMedia=function(){navigator.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia,navigator.getUserMedia(WebRTC.constraints,this.getLocalStream.bind(this),this.streamError.bind(this))},WebRTC.getLocalStream=function(e){Chat.clearHistory(),this.localStream=e,Socket.create(),WebRTC.create(),Chat.localVideo.src=URL.createObjectURL(e),Chat.localStream.classList.remove("camera-off"),this.getStream()},WebRTC.getRemoteStream=function(e){this.remoteStream=e.stream,Chat.remoteVideo.src=URL.createObjectURL(e.stream),Chat.remoteStream.classList.remove("loading"),Chat.clearHistory(),Chat.log(Lang.get("log_partner_conected"),!0),this.getStream()},WebRTC.getStream=function(){setTimeout(Resize.video,2e3)},WebRTC.getError=function(){Chat.log(Lang.get("log_webrtc_error"))},WebRTC.close=function(){WebRTC.pc&&(WebRTC.pc.close(),WebRTC.pc=null)},WebRTC.refresh=function(){WebRTC.close(),WebRTC.create()},WebRTC.gotLocalDescription=function(e){this.pc.setLocalDescription(e),Socket.sendMessage("webrtc",e)},WebRTC.streamError=function(){Chat.log(Lang.get("log_stream_error")),console.warn("Stream error")},WebRTC.getIceCandidate=function(e){e.candidate&&Socket.sendMessage("webrtc",{type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate})},WebRTC.createOffer=function(){this.pc.createOffer(this.gotLocalDescription.bind(this),this.getError,{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}})},WebRTC.createAnswer=function(){this.pc.createAnswer(this.gotLocalDescription.bind(this),this.getError,{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}})},WebRTC.onMessage=function(e){"offer"==e.type?(this.pc.setRemoteDescription(new window.SessionDescription(e)),WebRTC.createAnswer()):"answer"==e.type?this.pc.setRemoteDescription(new window.SessionDescription(e)):"candidate"==e.type&&this.pc.addIceCandidate(new window.IceCandidate({sdpMLineIndex:e.label,candidate:e.candidate}))};
//# sourceMappingURL=main.js.map
